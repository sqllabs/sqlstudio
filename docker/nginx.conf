error_log                    /usr/local/openresty/nginx/logs/error.log warn;
pid                          /usr/local/openresty/nginx/logs/nginx.pid;
user                         nginx;
worker_processes             auto;
worker_cpu_affinity          auto;
worker_rlimit_nofile         200000;

events {
    worker_connections       65535;
    use                      epoll;
    accept_mutex             off;
    multi_accept             on;
}

http {
    map $http_upgrade $connection_upgrade {
        default upgrade;
        '' close;
    }
    log_format               log-json-format escape=json
                             '{'
                                 '"remote_addr":"$remote_addr",'
                                 '"remote_port":"$remote_port",'
                                 '"remote_user":"$remote_user",'
                                 '"time_local":"$time_local",'
                                 '"request":"$request",'
                                 '"status":"$status",'
                                 '"body_bytes_sent":"$body_bytes_sent",'
                                 '"http_referer":"$http_referer",'
                                 '"http_user_agent":"$http_user_agent",'
                                 '"http_x_forwarded_for":"$http_x_forwarded_for",'
                                 '"request_body":"$request_body",'
                                 '"bytes_sent":"$bytes_sent",'
                                 '"upstream_addr":"$upstream_addr",'
                                 '"upstream_bytes_sent":"$upstream_bytes_sent",'
                                 '"upstream_bytes_received":"$upstream_bytes_received",'
                                 '"upstream_connect_time":"$upstream_connect_time",'
                                 '"http_cf_ipcountry":"$http_cf_ipcountry",'
                                 '"http_cf_connecting_ip":"$http_cf_connecting_ip",'
                                 '"http_cf_ray":"$http_cf_ray",'
                                 '"http_cf_visitor":"$http_cf_visitor",'
                                 '"http_cf_cache_status":"$http_cf_cache_status",'
                                 '"http_cf_request_id":"$http_cf_request_id",'
                                 '"http_cf_worker":"$http_cf_worker",'
                                 '"http_cf_ew_via":"$http_cf_ew_via",'
                                 '"http_cf_request_status":"$http_cf_request_status",'
                                 '"http_cf_device_type":"$http_cf_device_type",'
                                 '"http_cf_railgun":"$http_cf_railgun"'
                             '}';
    log_format               main '$remote_addr - $remote_port - $remote_user [$time_local] "$request" '
                             '$status $body_bytes_sent "$http_referer" '
                             '"$http_user_agent" "$http_x_forwarded_for" "$request_body" '
                             '$bytes_sent '
                             '"$upstream_addr" "$upstream_bytes_sent" "$upstream_bytes_received" '
                             '"$upstream_connect_time" '
                             '"$http_cf_ipcountry" "$http_cf_connecting_ip" "$http_cf_ray" '
                             '"$http_cf_visitor" "$http_cf_cache_status" "$http_cf_request_id" "$http_cf_worker" '
                             '"$http_cf_ew_via" "$http_cf_request_status" "$http_cf_device_type" "$http_cf_railgun" ';
    charset                        utf-8;
    charset_types                  text/*;
    client_body_timeout            60s;
    client_header_timeout          30s;
    default_type                   application/octet-stream;
    index                          index index.html index.htm index.php;
    client_body_buffer_size        32k;
    client_header_buffer_size      32k;
    client_max_body_size           100m;
    large_client_header_buffers    8 16k;
    gzip                           on;
    gzip_comp_level                4;
    gzip_disable                   "MSIE [1-6]\.";
    gzip_http_version              1.1;
    gzip_min_length                1k;
    gzip_types                     text/plain text/css application/json application/javascript application/x-javascript text/xml application/xml application/xml+rss text/javascript;
    gzip_static                    on;
    gzip_vary                      on;
    gzip_proxied                   no-cache no-store private expired auth;
    gzip_buffers                   16 8k;
    keepalive_requests             100000;
    keepalive_timeout              30s;
    open_file_cache                max=200000 inactive=30s;
    open_file_cache_valid          30s;
    open_file_cache_min_uses       2;
    open_file_cache_errors         on;
    tcp_nodelay                    on;
    tcp_nopush                     on;
    sendfile                       on;
    send_timeout                   30s;
    types_hash_max_size            2048;
    variables_hash_max_size        2048;
    variables_hash_bucket_size     64;
    include                        /usr/local/openresty/nginx/conf.d/*.http.conf;
    include                        /usr/local/openresty/nginx/conf/mime.types;
    server_tokens                  off;
    access_log                     /usr/local/openresty/nginx/logs/access.log main buffer=256k flush=5s;
    ssl_session_cache              shared:SSL:50m;
}

stream {
    log_format               log-json-format escape=json
                             '{'
                                 '"remote_addr":"$remote_addr",'
                                 '"remote_port":"$remote_port",'
                                 '"time_local":"$time_local",'
                                 '"status":"$status",'
                                 '"protocol":"$protocol",'
                                 '"bytes_sent":"$bytes_sent",'
                                 '"bytes_received":"$bytes_received",'
                                 '"session_time":"$session_time",'
                                 '"upstream_addr":"$upstream_addr",'
                                 '"upstream_bytes_sent":"$upstream_bytes_sent",'
                                 '"upstream_bytes_received":"$upstream_bytes_received",'
                                 '"upstream_connect_time":"$upstream_connect_time"'
                             '}';
    log_format               main '$remote_addr - $remote_port - [$time_local] $status '
                             '$protocol $bytes_sent $bytes_received $session_time '
                             '"$upstream_addr" "$upstream_bytes_sent" "$upstream_bytes_received" "$upstream_connect_time" ';
    include /usr/local/openresty/nginx/conf.d/*.stream.conf;
}
